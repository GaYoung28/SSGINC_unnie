<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>내주변</title>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=mt2l2d8ewa"></script>
    <style>
        /* 지도를 담을 컨테이너 (지도의 크기와 위치 설정) */
        #map-container {
            width: 640px;
            height: 640px;
            margin: 0 auto; /* 화면 중앙 정렬 */
            position: relative; /* 자식 요소(button)를 절대 위치로 배치하기 위해 사용 */
            border: 1px solid #ccc;
        }

        /* 실제 지도 영역 */
        #map {
            width: 100%;
            height: 100%;
        }

        /* "이 지역 재검색" 버튼 스타일 */
        #reSearchBtn {
            position: absolute;
            top: 10px;        /* 지도 위에서의 위치 (px 단위) */
            left: 50%;        /* 가로 기준 중앙에 맞춤 */
            transform: translateX(-50%); /* 버튼을 정확히 중앙에 오도록 조정 */
            z-index: 9999;    /* 지도 위에 표시되도록 높은 z-index 설정 */
            background-color: white;
            border: 1px solid #ccc;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            color : #FF3479
        }
        #reSearchBtn:hover {
            background-color: #eee;
        }
    </style>
</head>
<body>
<div id="map-container">
    <div id="map"></div>
    <button id="reSearchBtn">이 지역 재검색</button>
</div>

<script>
    let map;
    let markers = []; // 마커를 저장할 배열

    // 카테고리에 따른 마커 이미지 경로 반환 함수
    function getMarkerIcon(category) {
        const normalized = category.trim();
        switch(normalized) {
            case "헤어샵":
                return '/img/map_hair.png';
            case "네일샵":
                return '/img/map_neil.png';
            case "에스테틱":
                return '/img/map_aesthetic.png';
            case "왁싱샵":
                return '/img/map_waxing.png';
            case "바버샵":
                return '/img/map_barber.png';
            default:
                console.warn("지원하지 않는 카테고리:", category);
                return '/img/map_default.png';
        }
    }

    // 화면에 보이는 영역 내의 상점만 마커로 표시
    function filterShopsInView(shops) {
        const bounds = map.getBounds(); // 현재 지도에서 보이는 영역의 bounds(좌측상단, 우측하단 좌표)

        // 지도 영역 내에 있는 상점들만 필터링
        return shops.filter(shop => {
            const shopLatLng = new naver.maps.LatLng(shop.shopLatitude, shop.shopLongitude);
            return bounds.hasLatLng(shopLatLng); // 현재 지도 영역 내에 상점이 포함되면 true
        });
    }

    // 이전 마커를 모두 제거
    function removeMarkers() {
        markers.forEach(marker => {
            marker.setMap(null); // 마커를 지도에서 제거
        });
        markers = []; // 마커 배열 초기화
    }

    function initMap(lat, lng, shops) {
        const mapOptions = {
            center: new naver.maps.LatLng(lat, lng),
            zoom: 15
        };
        map = new naver.maps.Map('map', mapOptions);

        // 상점들의 위치로 마커 찍기
        const visibleShops = filterShopsInView(shops); // 현재 화면에 보이는 상점만 필터링

        visibleShops.forEach(shop => {
            const shopLat = shop.shopLatitude;
            const shopLng = shop.shopLongitude;
            const shopName = shop.shopName;
            const shopCategory = shop.shopCategory;
            const iconUrl = getMarkerIcon(shopCategory);

            const marker = new naver.maps.Marker({
                position: new naver.maps.LatLng(shopLat, shopLng),
                map: map,
                title: `${shopName} - ${shopCategory}`,
                icon: {
                    url: iconUrl,
                    size: new naver.maps.Size(40, 40),
                    anchor: new naver.maps.Point(20, 20)
                }
            });

            markers.push(marker); // 마커를 배열에 추가
        });
    }

    // 페이지 로드 시 자동으로 위치 및 데이터 로드
    function getLocationAndInit() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                // 서버에서 상점 데이터 가져오기
                fetch('/api/shop')
                    .then(response => response.json())
                    .then(data => {
                        const shops = data.data.shops; // 상점 데이터
                        initMap(lat, lng, shops);
                    })
                    .catch(error => {
                        console.error('상점 데이터를 가져오는 데 실패했습니다:', error);
                    });
            }, error => {
                console.error('위치 정보를 가져올 수 없습니다:', error.message);
            });
        } else {
            console.error('브라우저가 위치 정보를 지원하지 않습니다.');
        }
    }

    // "이 지역 재검색" 버튼 클릭 시 현재 지도 영역 내에서 마커 새로 로드
    document.getElementById('reSearchBtn').addEventListener('click', () => {
        // 현재 지도 중심 좌표와 zoom 비율을 가져옴
        const center = map.getCenter();
        const lat = center.lat();
        const lng = center.lng();
        const zoom = map.getZoom(); // 현재 zoom 비율을 저장

        // 서버에서 상점 데이터 가져오기
        fetch('/api/shop')
            .then(response => response.json())
            .then(data => {
                const shops = data.data.shops; // 상점 데이터
                removeMarkers(); // 기존 마커 제거
                initMap(lat, lng, shops); // 현재 위치 그대로 마커 새로 표시
                map.setZoom(zoom); // zoom 비율을 기존대로 유지
            })
            .catch(error => {
                console.error('상점 데이터를 가져오는 데 실패했습니다:', error);
            });
    });

    // 페이지 로드 시 자동으로 위치 및 데이터 로드
    document.addEventListener('DOMContentLoaded', getLocationAndInit);

    // 지도 이동이나 zoom 변경 시마다 마커 갱신
    map.addListener('zoom_changed', () => {
        const center = map.getCenter();
        const lat = center.lat();
        const lng = center.lng();
        const zoom = map.getZoom(); // 현재 zoom 비율을 저장

        // 서버에서 상점 데이터 가져오기
        fetch('/api/shop')
            .then(response => response.json())
            .then(data => {
                const shops = data.data.shops; // 상점 데이터
                removeMarkers(); // 기존 마커 제거
                initMap(lat, lng, shops); // 현재 위치 그대로 마커 새로 표시
                map.setZoom(zoom); // zoom 비율을 기존대로 유지
            })
            .catch(error => {
                console.error('상점 데이터를 가져오는 데 실패했습니다:', error);
            });
    });

    // 페이지 로드 시 자동으로 위치 및 데이터 로드
    document.addEventListener('DOMContentLoaded', getLocationAndInit);
</script>
</body>
</html>
