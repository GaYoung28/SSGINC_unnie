<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>네이버 지도 - 현재 위치 표시</title>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=mt2l2d8ewa"></script>
    <style>
        /* 지도를 담을 컨테이너 (지도의 크기와 위치 설정) */
        #map-container {
            width: 640px;
            height: 640px;
            margin: 0 auto; /* 화면 중앙 정렬 */
            position: relative; /* 자식 요소(button)를 절대 위치로 배치하기 위해 사용 */
            border: 1px solid #ccc; /* 지도 영역 구분용 테두리(선택사항) */
        }

        /* 실제 지도 영역 */
        #map {
            width: 100%;
            height: 100%;
        }

        /* "이 지역 재검색" 버튼 스타일 */
        #reSearchBtn {
            position: absolute;
            top: 10px;        /* 지도 위에서의 위치 (px 단위) */
            left: 50%;        /* 가로 기준 중앙에 맞춤 */
            transform: translateX(-50%); /* 버튼을 정확히 중앙에 오도록 조정 */
            z-index: 9999;    /* 지도 위에 표시되도록 높은 z-index 설정 */
            background-color: white;
            border: 1px solid #ccc;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            color : #FF3479
        }
        #reSearchBtn:hover {
            background-color: #eee;
        }
    </style>
</head>
<body>
<div id="map-container">
    <div id="map"></div>
    <button id="reSearchBtn">이 지역 재검색</button>
</div>

<script>
    let map;

    // 카테고리에 따른 마커 이미지 경로 반환 함수
    function getMarkerIcon(category) {
        const normalized = category.trim();
        switch(normalized) {
            case "헤어샵":
                return '/img/map_hair.png';
            case "네일샵":
                return '/img/map_neil.png';
            case "에스테틱":
                return '/img/map_aesthetic.png';
            case "왁싱샵":
                return '/img/map_waxing.png';
            case "바버샵":
                return '/img/map_barber.png';
            default:
                console.warn("지원하지 않는 카테고리:", category);
                return '/img/map_default.png';
        }
    }

    function initMap(lat, lng, shops) {
        const mapOptions = {
            center: new naver.maps.LatLng(lat, lng),
            zoom: 15
        };
        map = new naver.maps.Map('map', mapOptions);


        // 상점들의 위치로 마커 찍기
        shops.forEach(shop => {
            const shopLat = shop.shopLatitude;
            const shopLng = shop.shopLongitude;
            const shopName = shop.shopName;
            const shopCategory = shop.shopCategory;
            const iconUrl = getMarkerIcon(shopCategory);

            new naver.maps.Marker({
                position: new naver.maps.LatLng(shopLat, shopLng),
                map: map,
                title: `${shopName} - ${shopCategory}`,
                icon: {
                    url: iconUrl,
                    size: new naver.maps.Size(40, 40),
                    anchor: new naver.maps.Point(20, 20)
                }
            });
        });
    }

    function getLocationAndInit() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                // 서버에서 상점 데이터 가져오기
                fetch('/api/shop')
                    .then(response => response.json())
                    .then(data => {
                        const shops = data.data.shops; // 상점 데이터
                        initMap(lat, lng, shops);
                    })
                    .catch(error => {
                        console.error('상점 데이터를 가져오는 데 실패했습니다:', error);
                    });
            }, error => {
                console.error('위치 정보를 가져올 수 없습니다:', error.message);
            });
        } else {
            console.error('브라우저가 위치 정보를 지원하지 않습니다.');
        }
    }

    // 페이지 로드 시 자동으로 위치 및 데이터 로드
    document.addEventListener('DOMContentLoaded', getLocationAndInit);

    // "이 지역 재검색" 버튼 클릭 시 페이지 새로고침
    document.getElementById('reSearchBtn').addEventListener('click', () => {
        location.reload();
    });
</script>
</body>
</html>
